<html>
<head>
	<title>Flash desktop viewer</title>
	<script>
	
	var mx = 0
	var my = 0;
	var ms = "up";
	var dirty = false;
	var keys = new Array();
	
	function updateMouse(e) {
		e = window.event ? window.event : e;
		if (e.clientX != mx || e.clientY != my) {
			mx = e.clientX;
			my = e.clientY;
			dirty = true;
		}
	}
	
	function keyDown(e) {
		var id = (window.event) ? event.keyCode : e.keyCode;
		keys.push(id);
		call('http://10.0.1.163:8000/keydown?id=' + id);
	}
	
	function keyUp(e) {
		var id = (window.event) ? event.keyCode : e.keyCode;
		keys = keys.splice(keys.indexOf(id), 1);
		call('http://10.0.1.163:8000/keyup?id=' + id);
	}
	
	function getState() {
		var obj = document.getElementById('desktop');
		var curleft = curtop = 0;
		var pos = new Object();
		do {
			curleft += obj.offsetLeft;
			curtop += obj.offsetTop;
		} while (obj = obj.offsetParent);
		pos.x = mx - curleft;
		pos.y = my - curtop;
		if (pos.x < 0) pos.x = 0;
		if (pos.y < 0) pos.y = 0;
		return pos;
	}
	
	function call(url) {
		var req = null;
		req = new XMLHttpRequest(); 
		req.open("GET", url, true);
		req.send(null);
	}
		
	function mouseMove(pos) {
		call('http://10.0.1.163:8000/move?x=' + pos.x + '&y=' + pos.y);
	}

	function mouseUp() {
		pos = getState();
		ms = "up";
		call('http://10.0.1.163:8000/up?x=' + pos.x + '&y=' + pos.y);
	}

	function mouseDown() {
		pos = getState();
		ms = "down";
		call('http://10.0.1.163:8000/down?x=' + pos.x + '&y=' + pos.y);
	}
	
	function loop() {
		pos = getState();
		var status = 'x: ' + pos.x + ' y: ' + pos.y + ' mouse: ' + ms + ' keys: ' + keys.join(',');
	    document.getElementById('desktop').innerText = status;
		if (dirty) {
			mouseMove(pos);
			dirty = false;
		}
	}
	
	setInterval(loop, 100);
	
	</script>
</head>
<body onkeyup="return keyUp(event);" onkeydown="return keyDown(event);" >
	<div onmousemove=updateMouse() onmousedown=mouseDown() onmouseup=mouseUp() id="desktop" style="width: 100%; height: 100%; background-color: #FF0000;"><div>
</body>
</html>